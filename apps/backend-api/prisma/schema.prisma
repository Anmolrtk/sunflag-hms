generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Enums
enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  PHARMACIST
  PATIENT
}

// 2. The Master User Table (Doctors/Staff Logins)
model User {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  fullName    String
  phone       String?
  role        UserRole  @default(PATIENT)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  doctorProfile DoctorProfile?
  staffProfile  StaffProfile?
  
  // Doctors have appointments
  appointmentsAsDoctor Appointment[]
  
  @@map("users")
}

// 3. Doctor Specific Details
model DoctorProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  specialization  String
  licenseNumber   String
  department      String
  consultationFee Decimal  @db.Decimal(10, 2)
  
  @@map("doctor_profiles")
}

// 4. Staff Details
model StaffProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  employeeId    String   @unique
  department    String
  joiningDate   DateTime

  @@map("staff_profiles")
}

// 5. Patients (The Sick People)
model Patient {
  id            Int      @id @default(autoincrement()) // ID is a Number
  uhid          String?  @unique @default(uuid()) // Auto-generate UHID
  
  name          String
  phone         String   @default("")
  email         String?
  gender        String
  dob           DateTime // Renamed from dateOfBirth to match your code
  address       String?
  
  // Medical Info
  allergies     String?
  chronicDiseases String?

  appointments  Appointment[]
  invoices      Invoice[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("patients")
}

// 6. Appointments
model Appointment {
  id        Int      @id @default(autoincrement()) // ID is a Number
  reason    String   @default("Checkup")
  date      DateTime
  status    String   @default("PENDING")
  type      String   @default("CONSULTATION")
  
  // RELATION FIX: Link to Patient (Int ID)
  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id])
  
  // RELATION FIX: Link to User (String ID) - Because Doctors are Users
  doctorId  String
  doctor    User    @relation(fields: [doctorId], references: [id])
  
  invoices     Invoice?
  prescription Prescription?
  
  createdAt DateTime @default(now())
}

// 7. Invoices
model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique @default(uuid())
  totalAmount   Float
  status        String   @default("PENDING")
  
  // RELATION FIX: Link to Patient (Int ID)
  patientId     Int
  patient       Patient  @relation(fields: [patientId], references: [id])
  
  // RELATION FIX: Link to Appointment (Int ID)
  appointmentId Int?     @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  items         InvoiceItem[]
  
  createdAt     DateTime @default(now())
}

model InvoiceItem {
  id          String  @id @default(uuid())
  description String
  amount      Float
  quantity    Int     @default(1)
  
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
}

// 8. Prescriptions
model Prescription {
  id            String   @id @default(uuid())
  diagnosis     String
  notes         String?
  
  // RELATION FIX: Link to Appointment (Int ID)
  appointmentId Int   @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  
  medicines     PrescriptionMedicine[]

  createdAt     DateTime @default(now())
}

model PrescriptionMedicine {
  id             String  @id @default(uuid())
  medicineName   String
  dosage         String
  duration       String
  instruction    String?

  prescriptionId String
  prescription   Prescription @relation(fields: [prescriptionId], references: [id])
}
