generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String
  phone     String?
  role      String   @default("PATIENT") // DOCTOR, NURSE, ADMIN, PATIENT
  image     String?
  createdAt DateTime @default(now())

  // Profiles
  doctorProfile  DoctorProfile?
  patientProfile PatientProfile?

  // Relations
  appointmentsAsDoctor  Appointment[]  @relation("DoctorAppointments")
  appointmentsAsPatient Appointment[]  @relation("PatientAppointments")
  prescriptionsWritten  Prescription[]
  invoices              Invoice[]
}

model DoctorProfile {
  id              String  @id @default(uuid())
  specialization  String
  licenseNumber   String?
  department      String
  consultationFee Decimal @db.Decimal(10, 2)

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PatientProfile {
  id             String  @id @default(uuid())
  dob            String
  gender         String
  bloodGroup     String?
  address        String?
  medicalHistory String?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Appointment {
  id           String   @id @default(uuid())
  patientName  String   // Fallback for guests
  patientPhone String   // Fallback for guests
  date         DateTime
  reason       String?
  status       String   @default("PENDING")

  // Link to Doctor
  doctorId String
  doctor   User   @relation("DoctorAppointments", fields: [doctorId], references: [id])

  // Link to Patient (Optional - for Registered Users)
  patientId String?
  patient   User?   @relation("PatientAppointments", fields: [patientId], references: [id])

  // One-to-One Links
  prescription Prescription?
  invoice      Invoice?

  createdAt DateTime @default(now())
}

model Prescription {
  id        String   @id @default(uuid())
  medicines String   @db.Text // JSON String of medicines
  notes     String?

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id])

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])

  createdAt DateTime @default(now())
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique // e.g. INV-1001
  amount        Decimal  @db.Decimal(10, 2)
  status        String   @default("PENDING") // PAID, PENDING, CANCELLED
  paymentMode   String?

  patientId String
  patient   User   @relation(fields: [patientId], references: [id])

  appointmentId String?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  items InvoiceItem[]

  createdAt DateTime @default(now())
}

model InvoiceItem {
  id          String  @id @default(uuid())
  description String
  quantity    Int
  price       Decimal @db.Decimal(10, 2)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}
